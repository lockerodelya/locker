<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odelya Locker - User Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .header {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .content {
            padding: 40px;
            min-height: 500px;
        }

        /* Search Section */
        .search-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #2196f3;
        }

        .search-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #424242;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: #2196f3;
            outline: none;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .btn-login {
            width: 100%;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-login:hover {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(33, 150, 243, 0.3);
        }

        .btn-recharge {
            width: 100%;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .btn-recharge:hover {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(33, 150, 243, 0.3);
        }

        .btn-forgot-password {
            background: transparent;
            color: #2196f3;
            border: none;
            padding: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 15px auto 0;
            text-align: center;
        }

        .btn-forgot-password:hover {
            color: #0d47a1;
            text-decoration: underline;
        }

        .btn-change-password {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-change-password:hover {
            background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.3);
        }

        .btn-change-password-urgent {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            animation: pulse 2s infinite;
        }

        .btn-change-password-urgent:hover {
            background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 68, 68, 0.4);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .error-message {
            color: #f44336;
            font-size: 1rem;
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background: #ffebee;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            display: none;
        }

        .success-message {
            color: #1b5e20;
            font-size: 1rem;
            margin-top: 15px;
            text-align: center;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            display: none;
        }

        /* User Info Display */
        .user-info-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .user-info-header h2 {
            color: #1a237e;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: center;
            flex: 1;
            justify-content: center;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .logout-btn-header {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(244, 67, 54, 0.3);
        }

        .logout-btn-header:hover {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(244, 67, 54, 0.4);
        }

        /* User Account Sections */
        .account-sections {
            display: flex;
            flex-direction: column;
            gap: 40px;
            margin-bottom: 40px;
        }

        .account-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border-left: 5px solid #2196f3;
        }

        .account-section.personal {
            border-left-color: #2196f3;
            max-width: 800px;
            margin: 0 auto;
        }

        .account-section.plan-history {
            border-left-color: #4caf50;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            text-align: center;
            justify-content: center;
        }

        .section-header h3 {
            color: #1a237e;
            font-size: 1.6rem;
        }

        .section-header i {
            color: #1a237e;
            font-size: 1.6rem;
        }

        .info-grid {
            display: grid;
            gap: 15px;
        }

        .info-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .info-label {
            font-weight: 600;
            color: #424242;
            font-size: 1.1rem;
        }

        .info-value {
            color: #666;
            word-break: break-word;
            font-size: 1.1rem;
        }

        .info-value.highlight {
            color: #1a237e;
            font-weight: 600;
        }

        /* Plan History Table */
        .plan-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .plan-history-table th {
            background: linear-gradient(135deg, #4caf50 0%, #2E7D32 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .plan-history-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #666;
        }

        .plan-history-table tr:last-child td {
            border-bottom: none;
        }

        .plan-history-table tr:nth-child(even) {
            background-color: #f8f9ff;
        }

        .plan-history-table tr:hover {
            background-color: #e8f5e9;
        }

        .status-active {
            color: #1b5e20;
            background: #e8f5e9;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-inactive {
            color: #c62828;
            background: #ffebee;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-block;
        }

        /* Security Alert for First Time Login */
        .security-alert {
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            border-left: 5px solid #ff9800;
            border-right: 5px solid #ff9800;
            animation: shakeAlert 0.5s ease;
        }

        @keyframes shakeAlert {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .security-alert h4 {
            color: #e65100;
            margin-bottom: 10px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .security-alert p {
            color: #5d4037;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            background: #f8f9ff;
            border-top: 2px solid #e0e0e0;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2196f3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Password format example */
        .password-format-example {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* Date format example */
        .date-format-example {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* First time login note */
        .first-time-note {
            background: #fff3e0;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            color: #e65100;
            font-weight: 500;
            border-left: 4px solid #ff9800;
            display: none;
        }

        .first-time-note i {
            margin-right: 10px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #ff9800;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-form .form-group {
            margin-bottom: 20px;
        }

        .password-requirements {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }

        .password-match-error {
            color: #f44336;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-submit {
            flex: 1;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-submit:hover:not(:disabled) {
            background: linear-gradient(135deg, #388e3c 0%, #1b5e20 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-cancel {
            flex: 1;
            background: #f5f5f5;
            color: #666;
            border: 2px solid #e0e0e0;
            padding: 14px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        .btn-reset-password {
            flex: 1;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-reset-password:hover:not(:disabled) {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        /* Success Toast */
        .password-success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.3);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .toast-message {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* User Log Store Section */
        .user-log-info {
            background: #fff8e1;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #ff9800;
            font-size: 0.9rem;
            color: #5d4037;
            display: none;
        }

        .user-log-info i {
            color: #ff9800;
            margin-right: 10px;
        }

        .no-history {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-user-shield"></i> Odelya Locker User Portal</h1>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Login Section -->
            <div class="search-section" id="loginSection">
                <form class="search-form" id="loginForm">
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email ID</label>
                        <input type="text" id="loginEmail" placeholder="Enter your Email ID" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your Odelya Locker password" required>
                        <div class="password-format-example">** Alert! Do not enter your email password, enter Odelya Locker password</div>
                        <div class="first-time-note" id="firstTimeNote">
                            <i class="fas fa-info-circle"></i> First time users: Please use the default password provided by administrator
                        </div>
                    </div>
                    
                    <div class="error-message" id="loginErrorMessage">
                        <i class="fas fa-exclamation-circle"></i> Invalid email or password. Please check your credentials.
                    </div>
                    
                    <div class="success-message" id="loginSuccessMessage">
                        <i class="fas fa-check-circle"></i> Login successful! Loading your information...
                    </div>
                    
                    <div class="loading-spinner" id="loginLoadingSpinner">
                        <div class="spinner"></div>
                        <p>Verifying your credentials...</p>
                    </div>
                    
                    <button type="submit" class="btn-login" id="btnLogin">
                        <i class="fas fa-sign-in-alt"></i> Log in
                    </button>

                    <button type="button" class="btn-forgot-password" onclick="openForgotPasswordModal()">
                        <i class="fas fa-question-circle"></i> Forgot Password?
                    </button>
                </form>
            </div>

            <!-- User Information Display -->
            <div class="user-info-section" id="userInfoSection">
                <div class="user-info-header">
                    <div style="flex: 1;"></div>
                    <h2><i class="fas fa-user-circle"></i> <span id="userNameAccount">User Name Account</span></h2>
                    <div class="header-actions">
                        <button class="btn-change-password" onclick="openChangePasswordModal()">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                        <button class="logout-btn-header" onclick="resetLogin()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
                
                <!-- Security Alert for First Time Login -->
                <div class="security-alert" id="securityAlert" style="display: none;">
                    <h4><i class="fas fa-exclamation-triangle"></i> Security Alert: Password Change Required</h4>
                    <p>You are using the default password. For security reasons, you must change your password immediately.</p>
                    <button class="btn-change-password-urgent" onclick="openChangePasswordModal()">
                        <i class="fas fa-key"></i> Change Password Now
                    </button>
                </div>
                
                <div class="account-sections">
                    <!-- Personal Information Section -->
                    <div class="account-section personal">
                        <div class="section-header">
                            <i class="fas fa-user"></i>
                            <h3>Personal Information</h3>
                        </div>
                        <div class="info-grid" id="personalInfo">
                            <!-- Info will be populated here -->
                        </div>
                    </div>

                    <!-- Plan History Section -->
                    <div class="account-section plan-history">
                        <div class="section-header">
                            <i class="fas fa-history"></i>
                            <h3>Plan History</h3>
                        </div>
                        <div id="planHistoryContent">
                            <!-- Plan history table will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Recharge Now Button -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-recharge" id="btnRecharge" onclick="rechargeNow()">
                        <i class="fas fa-sync-alt"></i> Recharge Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Â© 2025 Odelya Locker. All rights reserved. | For any queries, please contact support.</p>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotPasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Forgot Password</h3>
                <button class="close-modal" onclick="closeForgotPasswordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form class="modal-form" id="forgotPasswordForm">
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email ID</label>
                        <input type="text" id="forgotEmail" placeholder="Enter your registered Email ID" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Phone Number</label>
                        <input type="text" id="forgotPhone" placeholder="Enter your registered phone number" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-calendar-alt"></i> Date of Birth</label>
                        <input type="text" id="forgotDOB" placeholder="DD-MM-YYYY (e.g., 22-01-1990)" required>
                        <div class="date-format-example">Format: DD-MM-YYYY (e.g., 22-01-1990, 05-12-1985)</div>
                    </div>
                    
                    <div class="error-message" id="forgotPasswordError" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> Verification failed. Please check your details and try again.
                    </div>
                    
                    <div class="loading-spinner" id="forgotPasswordLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Verifying your information...</p>
                    </div>
                    
                    <div class="modal-actions" id="forgotPasswordActions">
                        <button type="button" class="btn-cancel" onclick="closeForgotPasswordModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn-submit" id="btnVerifyDetails">
                            <i class="fas fa-check"></i> Verify Details
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal-overlay" id="resetPasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Reset Password</h3>
                <button class="close-modal" onclick="closeResetPasswordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form class="modal-form" id="resetPasswordForm">
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> New Password</label>
                        <input type="password" id="resetNewPassword" placeholder="Enter new password" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Confirm New Password</label>
                        <input type="password" id="resetConfirmPassword" placeholder="Confirm new password" required>
                        <div class="password-match-error" id="resetPasswordMatchError">
                            <i class="fas fa-exclamation-circle"></i> Passwords do not match
                        </div>
                    </div>
                    
                    <div class="password-requirements">
                        <strong>Password Requirements:</strong>
                        <ul style="margin-top: 5px; padding-left: 20px;">
                            <li>Minimum 8 characters</li>
                            <li>At least one uppercase letter</li>
                            <li>At least one lowercase letter</li>
                            <li>At least one number</li>
                            <li>At least one special character</li>
                        </ul>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeResetPasswordModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn-reset-password" id="btnResetPassword">
                            <i class="fas fa-save"></i> Reset Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-overlay" id="changePasswordModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-key"></i> Change Password</h3>
                <button class="close-modal" onclick="closeChangePasswordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form class="modal-form" id="changePasswordForm">
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Enter current password" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Confirm New Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm new password" required>
                        <div class="password-match-error" id="passwordMatchError">
                            <i class="fas fa-exclamation-circle"></i> Passwords do not match
                        </div>
                    </div>
                    
                    <div class="password-requirements">
                        <strong>Password Requirements:</strong>
                        <ul style="margin-top: 5px; padding-left: 20px;">
                            <li>Minimum 8 characters</li>
                            <li>At least one uppercase letter</li>
                            <li>At least one lowercase letter</li>
                            <li>At least one number</li>
                            <li>At least one special character</li>
                        </ul>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeChangePasswordModal()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn-submit" id="btnSubmitPassword">
                            <i class="fas fa-save"></i> Change Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="password-success-toast" id="passwordSuccessToast">
        <div class="toast-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="toast-content">
            <div class="toast-title">Password Changed Successfully!</div>
            <div class="toast-message">You will be logged out automatically.</div>
        </div>
    </div>

    <script>
        // ====== DEFAULT PASSWORD ======
        const DEFAULT_PASSWORD = 'odelya@123';
        
        // ====== ENCRYPTION/DECRYPTION FUNCTIONS ======
        const ENCRYPTION_KEY = 'odelya-secure-admin-key-2024!@#$';
        
        function encryptData(data) {
            try {
                let encrypted = '';
                for (let i = 0; i < data.length; i++) {
                    const charCode = data.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length);
                    encrypted += String.fromCharCode(charCode);
                }
                return btoa(encrypted);
            } catch (error) {
                console.error('Encryption error:', error);
                return data;
            }
        }
        
        function decryptData(encryptedData) {
            try {
                const decoded = atob(encryptedData);
                let decrypted = '';
                for (let i = 0; i < decoded.length; i++) {
                    const charCode = decoded.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length);
                    decrypted += String.fromCharCode(charCode);
                }
                return decrypted;
            } catch (error) {
                console.error('Decryption error:', error);
                return encryptedData;
            }
        }

        // ====== PERMANENT USER LOG STORAGE SYSTEM ======
        const USER_LOG_PREFIX = 'odelya_user_log_';
        const USER_DATA_PREFIX = 'odelya_user_data_';
        const PLAN_HISTORY_PREFIX = 'odelya_plan_history_';
        
        function saveUserDataPermanently(userData) {
            try {
                const userId = userData.userId || userData.email;
                if (!userId) return false;
                
                // Save to permanent data storage
                const dataKey = USER_DATA_PREFIX + userId;
                const permanentData = {
                    ...extractRequiredFields(userData),
                    savedAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    isPermanent: true,
                    source: 'admin_storage'
                };
                
                localStorage.setItem(dataKey, JSON.stringify(permanentData));
                
                // Also update log
                updateUserLog(userId, {
                    dataSavedAt: new Date().toISOString(),
                    isDataPermanent: true
                });
                
                // Save to plan history if it's a new plan
                saveToPlanHistory(userData);
                
                return true;
            } catch (error) {
                console.error('Error saving permanent user data:', error);
                return false;
            }
        }
        
        function saveToPlanHistory(userData) {
            try {
                const userId = userData.userId || userData.email;
                if (!userId) return false;
                
                const historyKey = PLAN_HISTORY_PREFIX + userId;
                let history = JSON.parse(localStorage.getItem(historyKey)) || [];
                
                // Check if this plan already exists in history
                const existingIndex = history.findIndex(item => 
                    item.planStartDate === userData.planStartDate && 
                    item.planName === userData.planName
                );
                
                if (existingIndex === -1) {
                    // Add new plan to history
                    const planRecord = {
                        planName: userData.planName || '',
                        planGB: userData.planGB || '',
                        planDuration: userData.planDuration || '',
                        planStartDate: userData.planStartDate || '',
                        planEndDate: userData.planEndDate || '',
                        amountPaid: userData.amountPaid || 0,
                        recordedAt: new Date().toISOString(),
                        isActive: true
                    };
                    
                    // Deactivate previous plans
                    history.forEach(item => item.isActive = false);
                    
                    history.unshift(planRecord); // Add to beginning
                    
                    // Keep only last 36 months of history (3 years)
                    if (history.length > 36) {
                        history = history.slice(0, 36);
                    }
                    
                    localStorage.setItem(historyKey, JSON.stringify(history));
                }
                
                return true;
            } catch (error) {
                console.error('Error saving to plan history:', error);
                return false;
            }
        }
        
        function getPlanHistory(userIdOrEmail) {
            try {
                const historyKey = PLAN_HISTORY_PREFIX + userIdOrEmail;
                const history = localStorage.getItem(historyKey);
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('Error getting plan history:', error);
                return [];
            }
        }
        
        function getUserDataPermanently(userIdOrEmail) {
            try {
                const dataKey = USER_DATA_PREFIX + userIdOrEmail;
                const data = localStorage.getItem(dataKey);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error getting permanent user data:', error);
                return null;
            }
        }
        
        function updateUserLog(userIdOrEmail, updates) {
            try {
                const logKey = USER_LOG_PREFIX + userIdOrEmail;
                let logData = getUserLog(userIdOrEmail) || {};
                
                logData = {
                    ...logData,
                    ...updates,
                    logUpdatedAt: new Date().toISOString()
                };
                
                localStorage.setItem(logKey, JSON.stringify(logData));
                return true;
            } catch (error) {
                console.error('Error updating user log:', error);
                return false;
            }
        }
        
        function getUserLog(userIdOrEmail) {
            try {
                const logKey = USER_LOG_PREFIX + userIdOrEmail;
                const logData = localStorage.getItem(logKey);
                return logData ? JSON.parse(logData) : null;
            } catch (error) {
                console.error('Error getting user log:', error);
                return null;
            }
        }
        
        function extractRequiredFields(userData) {
            const extracted = {
                userId: userData.userId || '',
                fullName: userData.fullName || '',
                dob: extractDOB(userData),
                email: extractEmail(userData),
                phone: extractPhone(userData),
                planName: userData.serviceType || '',
                planGB: userData.planGB || '',
                planDuration: userData.duration || '',
                planStartDate: userData.planStart || '',
                planEndDate: userData.planEnd || '',
                amountPaid: userData.amount || 0,
                encryptedData: userData.encryptedData || '',
                registrationDate: userData.registrationDate || '',
                isFirstLogin: userData.isFirstLogin !== false
            };
            
            return extracted;
        }
        
        function extractDOB(userData) {
            try {
                if (userData.encryptedData) {
                    const decrypted = JSON.parse(decryptData(userData.encryptedData));
                    return decrypted.personalInfo?.dob || '';
                }
            } catch (error) {
                console.error('Error extracting DOB:', error);
            }
            return '';
        }
        
        function extractEmail(userData) {
            try {
                if (userData.encryptedData) {
                    const decrypted = JSON.parse(decryptData(userData.encryptedData));
                    return decrypted.personalInfo?.email || '';
                }
            } catch (error) {
                console.error('Error extracting email:', error);
            }
            return userData.email || '';
        }
        
        function extractPhone(userData) {
            try {
                if (userData.encryptedData) {
                    const decrypted = JSON.parse(decryptData(userData.encryptedData));
                    return decrypted.personalInfo?.phone || '';
                }
            } catch (error) {
                console.error('Error extracting phone:', error);
            }
            return userData.phone || '';
        }

        // ====== SEARCH FOR USER DATA ======
        function searchUserData(email, password) {
            try {
                // First check permanent data storage
                const permanentData = getUserDataPermanently(email);
                if (permanentData && verifyPassword(permanentData, password)) {
                    return permanentData;
                }
                
                // If not in permanent storage, check admin storage
                const keys = Object.keys(localStorage);
                
                for (const key of keys) {
                    if (key.startsWith('user_')) {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            
                            // Check if this is the user by email
                            let userEmail = '';
                            try {
                                if (userData.encryptedData) {
                                    const decrypted = JSON.parse(decryptData(userData.encryptedData));
                                    userEmail = decrypted.personalInfo?.email || '';
                                }
                            } catch (decryptError) {
                                console.error('Error decrypting email:', decryptError);
                            }
                            
                            if (!userEmail && userData.email) {
                                try {
                                    userEmail = decryptData(userData.email);
                                } catch (e) {
                                    userEmail = userData.email;
                                }
                            }
                            
                            if (userEmail === email || userData.userId === email) {
                                // Check password
                                const isFirstLogin = checkIfFirstLogin(userData, userEmail);
                                
                                if (isFirstLogin && password === DEFAULT_PASSWORD) {
                                    // First time login with default password
                                    const extracted = extractRequiredFields(userData);
                                    extracted.isFirstLogin = true;
                                    saveUserDataPermanently(extracted);
                                    updateUserLog(userEmail, { isFirstLogin: true });
                                    return extracted;
                                } else if (verifyPassword(userData, password)) {
                                    // Regular login
                                    const extracted = extractRequiredFields(userData);
                                    extracted.isFirstLogin = false;
                                    saveUserDataPermanently(extracted);
                                    updateUserLog(userEmail, { isFirstLogin: false });
                                    return extracted;
                                }
                            }
                        } catch (parseError) {
                            continue;
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error searching user data:', error);
                return null;
            }
        }
        
function checkIfFirstLogin(userData, email) {
    const userId = userData.userId || email;
    
    // First check the log
    const log = getUserLog(userId);
    if (log && log.isFirstLogin === false) {
        return false;
    }
    
    // Then check permanent data
    const permanentData = getUserDataPermanently(userId);
    if (permanentData && permanentData.isFirstLogin === false) {
        return false;
    }
    
    // Default to true if no evidence of password change
    return true;
}
        
function verifyPassword(userData, password) {
    try {
        // Check if this is a first-time login attempt
        const isFirstLoginAttempt = userData.isFirstLogin === true;
        
        // Check for default password - only allow if it's a genuine first login
        if (password === DEFAULT_PASSWORD) {
            // Allow default password only if:
            // 1. It's marked as first login in user data
            // 2. AND we can verify from the log that it's actually a first login
            if (isFirstLoginAttempt) {
                // Check user log to verify it's truly a first login
                const userId = userData.userId || userData.email;
                const userLog = getUserLog(userId);
                
                // If log exists and indicates it's not first login, reject default password
                if (userLog && userLog.isFirstLogin === false) {
                    console.log('Default password rejected - user has already changed password');
                    return false;
                }
                
                // Also check permanent storage for password change flag
                const permanentData = getUserDataPermanently(userId);
                if (permanentData && permanentData.isFirstLogin === false) {
                    console.log('Default password rejected - permanent data indicates password changed');
                    return false;
                }
                
                console.log('Default password accepted - genuine first login');
                return true;
            }
            return false;
        }
        
        // Check encrypted password
        if (userData.encryptedData) {
            const decrypted = JSON.parse(decryptData(userData.encryptedData));
            if (decrypted.password && decryptData(decrypted.password) === password) {
                return true;
            }
        }
        
        // Check direct password field
        if (userData.password) {
            try {
                const decryptedPassword = decryptData(userData.password);
                return decryptedPassword === password;
            } catch (e) {
                return userData.password === password;
            }
        }
        
        return false;
    } catch (error) {
        console.error('Error verifying password:', error);
        return false;
    }
}

        // ====== DOM ELEMENTS ======
        const elements = {
            loginForm: document.getElementById('loginForm'),
            loginEmail: document.getElementById('loginEmail'),
            loginPassword: document.getElementById('loginPassword'),
            loginErrorMessage: document.getElementById('loginErrorMessage'),
            loginSuccessMessage: document.getElementById('loginSuccessMessage'),
            loginLoadingSpinner: document.getElementById('loginLoadingSpinner'),
            btnLogin: document.getElementById('btnLogin'),
            firstTimeNote: document.getElementById('firstTimeNote'),
            
            loginSection: document.getElementById('loginSection'),
            userInfoSection: document.getElementById('userInfoSection'),
            
            personalInfo: document.getElementById('personalInfo'),
            planHistoryContent: document.getElementById('planHistoryContent'),
            userNameAccount: document.getElementById('userNameAccount'),
            
            securityAlert: document.getElementById('securityAlert'),
            
            forgotPasswordModal: document.getElementById('forgotPasswordModal'),
            forgotPasswordForm: document.getElementById('forgotPasswordForm'),
            forgotEmail: document.getElementById('forgotEmail'),
            forgotPhone: document.getElementById('forgotPhone'),
            forgotDOB: document.getElementById('forgotDOB'),
            forgotPasswordError: document.getElementById('forgotPasswordError'),
            forgotPasswordLoading: document.getElementById('forgotPasswordLoading'),
            forgotPasswordActions: document.getElementById('forgotPasswordActions'),
            btnVerifyDetails: document.getElementById('btnVerifyDetails'),
            
            resetPasswordModal: document.getElementById('resetPasswordModal'),
            resetPasswordForm: document.getElementById('resetPasswordForm'),
            resetNewPassword: document.getElementById('resetNewPassword'),
            resetConfirmPassword: document.getElementById('resetConfirmPassword'),
            resetPasswordMatchError: document.getElementById('resetPasswordMatchError'),
            btnResetPassword: document.getElementById('btnResetPassword'),
            
            changePasswordModal: document.getElementById('changePasswordModal'),
            changePasswordForm: document.getElementById('changePasswordForm'),
            currentPassword: document.getElementById('currentPassword'),
            newPassword: document.getElementById('newPassword'),
            confirmPassword: document.getElementById('confirmPassword'),
            passwordMatchError: document.getElementById('passwordMatchError'),
            btnSubmitPassword: document.getElementById('btnSubmitPassword'),
            
            passwordSuccessToast: document.getElementById('passwordSuccessToast'),
            btnRecharge: document.getElementById('btnRecharge')
        };

        // Current user data
        let currentUserData = null;
        let currentUserId = null;
        let userToReset = null;
        let isFirstTimeLogin = false;

        // ====== HELPER FUNCTIONS ======
        function normalizeDateForComparison(dateString) {
            dateString = dateString.trim().toLowerCase();
            
            if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
                return dateString;
            }
            
            const monthMap = {
                'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04',
                'may': '05', 'jun': '06', 'jul': '07', 'aug': '08',
                'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12'
            };
            
            const match = dateString.match(/^(\d{1,2})[-/\s\.]([a-z]{3})[-/\s\.](\d{4})$/i);
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = monthMap[match[2].toLowerCase().substring(0, 3)] || '01';
                const year = match[3];
                return `${day}-${month}-${year}`;
            }
            
            return dateString;
        }

        function formatDateToDDMMYYYY(dateString) {
            if (!dateString) return '';
            
            try {
                let date;
                
                if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
                    const parts = dateString.split('-');
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
                    const parts = dateString.split('/');
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    date = new Date(dateString);
                }
                
                if (!isNaN(date.getTime())) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}-${month}-${year}`;
                }
            } catch (e) {
                console.error('Date parsing error:', e);
            }
            
            return dateString;
        }

        function isDateInFuture(dateString) {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let targetDate;
                if (/^\d{2}-\d{2}-\d{4}$/.test(dateString)) {
                    const parts = dateString.split('-');
                    targetDate = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    targetDate = new Date(dateString);
                }
                
                if (!isNaN(targetDate.getTime())) {
                    targetDate.setHours(0, 0, 0, 0);
                    return targetDate >= today;
                }
            } catch (e) {
                console.error('Date comparison error:', e);
            }
            return false;
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validatePasswordStrength(password) {
            if (password.length < 8) return false;
            if (!/[A-Z]/.test(password)) return false;
            if (!/[a-z]/.test(password)) return false;
            if (!/\d/.test(password)) return false;
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) return false;
            return true;
        }

        function showFirstTimeNote() {
            elements.firstTimeNote.style.display = 'block';
        }

        function hideFirstTimeNote() {
            elements.firstTimeNote.style.display = 'none';
        }

        // ====== EVENT LISTENERS ======
        document.addEventListener('DOMContentLoaded', function() {
            elements.loginForm.addEventListener('submit', handleLogin);
            elements.forgotPasswordForm.addEventListener('submit', handleForgotPassword);
            elements.resetPasswordForm.addEventListener('submit', handleResetPassword);
            elements.changePasswordForm.addEventListener('submit', handleChangePassword);
            
            elements.confirmPassword.addEventListener('input', checkPasswordMatch);
            elements.resetConfirmPassword.addEventListener('input', checkResetPasswordMatch);
            
            elements.forgotDOB.addEventListener('blur', function() {
                const normalized = normalizeDateForComparison(this.value);
                if (normalized !== this.value) {
                    this.value = normalized;
                }
            });
            
            // Show first time note only when needed
            elements.loginEmail.addEventListener('focus', function() {
                showFirstTimeNote();
            });
            
            elements.loginPassword.addEventListener('focus', function() {
                hideFirstTimeNote();
            });
        });

        // ====== LOGIN FUNCTION ======
        function handleLogin(e) {
            e.preventDefault();
            
            const emailId = elements.loginEmail.value.trim();
            const password = elements.loginPassword.value.trim();
            
            if (!emailId || !password) {
                showLoginError('Please enter both Email ID and Password.');
                return;
            }
            
            if (!validateEmail(emailId)) {
                showLoginError('Please enter a valid email address.');
                return;
            }
            
            hideLoginError();
            hideFirstTimeNote();
            elements.loginLoadingSpinner.style.display = 'block';
            elements.btnLogin.disabled = true;
            
            setTimeout(() => {
                const userData = searchUserData(emailId, password);
                
                if (userData) {
                    currentUserData = userData;
                    currentUserId = userData.userId || emailId;
                    isFirstTimeLogin = userData.isFirstLogin === true;
                    
                    // Show success message
                    elements.loginSuccessMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        displayUserInfo(userData);
                        elements.loginSection.style.display = 'none';
                        elements.userInfoSection.style.display = 'block';
                        elements.loginSuccessMessage.style.display = 'none';
                        
                        // Show security alert if first time login
                        if (isFirstTimeLogin) {
                            elements.securityAlert.style.display = 'block';
                        }
                    }, 1000);
                } else {
                    showLoginError('Invalid email or password. Please check your credentials.');
                    shakeForm();
                }
                
                elements.loginLoadingSpinner.style.display = 'none';
                elements.btnLogin.disabled = false;
            }, 800);
        }

        // ====== USER INFO DISPLAY ======
        function displayUserInfo(userData) {
            // Update header with user's name
            elements.userNameAccount.textContent = userData.fullName || 'User Account';
            
            // Display personal information
            displayPersonalInfo(userData);
            
            // Display plan history
            displayPlanHistory(userData);
        }
        
        function displayPersonalInfo(userData) {
            elements.personalInfo.innerHTML = '';
            
            const formattedDOB = formatDateToDDMMYYYY(userData.dob || '');
            
            const personalInfoHTML = `
                <div class="info-row">
                    <span class="info-label">User ID:</span>
                    <span class="info-value highlight">${userData.userId || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Full Name:</span>
                    <span class="info-value">${userData.fullName || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Date of Birth:</span>
                    <span class="info-value">${formattedDOB || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email ID:</span>
                    <span class="info-value">${userData.email || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phone No.:</span>
                    <span class="info-value">${userData.phone || 'N/A'}</span>
                </div>
            `;
            
            elements.personalInfo.innerHTML = personalInfoHTML;
        }
        
        function displayPlanHistory(userData) {
            const userId = userData.userId || userData.email;
            let planHistory = getPlanHistory(userId);
            
            // Update plan statuses based on end dates
            planHistory = updatePlanStatuses(planHistory);
            
            // Save updated history
            localStorage.setItem(PLAN_HISTORY_PREFIX + userId, JSON.stringify(planHistory));
            
            // If no history exists, create one from current data
            if (planHistory.length === 0 && userData.planName) {
                // Create initial history from current data
                const initialHistory = [{
                    planName: userData.planName || '',
                    planGB: userData.planGB || '',
                    planDuration: userData.planDuration || '',
                    planStartDate: userData.planStartDate || '',
                    planEndDate: userData.planEndDate || '',
                    amountPaid: userData.amountPaid || 0,
                    recordedAt: new Date().toISOString(),
                    isActive: true
                }];
                
                localStorage.setItem(PLAN_HISTORY_PREFIX + userId, JSON.stringify(initialHistory));
                
                // Add sample historical data for demonstration
                addSampleHistoryData(userId);
                
                // Refresh with new data
                displayPlanHistory(userData);
                return;
            }
            
            if (planHistory.length === 0) {
                elements.planHistoryContent.innerHTML = `
                    <div class="no-history">
                        <i class="fas fa-history" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                        <p>No plan history found. Recharge to start your first plan.</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table class="plan-history-table">
                    <thead>
                        <tr>
                            <th>Plan Name</th>
                            <th>Plan (GB)</th>
                            <th>Duration</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Amount Paid</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            planHistory.forEach((plan, index) => {
                const formattedStartDate = formatDateToDDMMYYYY(plan.planStartDate || '');
                const formattedEndDate = formatDateToDDMMYYYY(plan.planEndDate || '');
                const isActive = plan.isActive;
                const statusClass = isActive ? 'status-active' : 'status-inactive';
                const statusText = isActive ? 'Active' : 'Inactive';
                
                tableHTML += `
                    <tr>
                        <td>${plan.planName || 'N/A'}</td>
                        <td>${plan.planGB || 'N/A'}</td>
                        <td>${plan.planDuration || 'N/A'}</td>
                        <td>${formattedStartDate || 'N/A'}</td>
                        <td>${formattedEndDate || 'Ongoing'}</td>
                        <td>INR ${plan.amountPaid || 0}</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            elements.planHistoryContent.innerHTML = tableHTML;
        }
        
        function updatePlanStatuses(planHistory) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return planHistory.map(plan => {
                let isActive = false;
                
                if (plan.planEndDate) {
                    try {
                        let endDate;
                        if (/^\d{2}-\d{2}-\d{4}$/.test(plan.planEndDate)) {
                            const parts = plan.planEndDate.split('-');
                            endDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        } else {
                            endDate = new Date(plan.planEndDate);
                        }
                        
                        if (!isNaN(endDate.getTime())) {
                            endDate.setHours(0, 0, 0, 0);
                            isActive = endDate >= today;
                        }
                    } catch (e) {
                        console.error('Error checking plan end date:', e);
                    }
                } else if (plan.planStartDate) {
                    // If no end date, check if start date is in the last 30 days
                    try {
                        let startDate;
                        if (/^\d{2}-\d{2}-\d{4}$/.test(plan.planStartDate)) {
                            const parts = plan.planStartDate.split('-');
                            startDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        } else {
                            startDate = new Date(plan.planStartDate);
                        }
                        
                        if (!isNaN(startDate.getTime())) {
                            startDate.setHours(0, 0, 0, 0);
                            const thirtyDaysAgo = new Date();
                            thirtyDaysAgo.setDate(today.getDate() - 30);
                            isActive = startDate >= thirtyDaysAgo;
                        }
                    } catch (e) {
                        console.error('Error checking plan start date:', e);
                    }
                }
                
                return {
                    ...plan,
                    isActive: isActive
                };
            });
        }
        
        function addSampleHistoryData(userId) {
            const historyKey = PLAN_HISTORY_PREFIX + userId;
            let history = JSON.parse(localStorage.getItem(historyKey)) || [];
            
            // Get today's date
            const today = new Date();
            
            // Add sample historical records for 36 months (3 years)
            const sampleRecords = [];
            
            for (let i = 0; i < 36; i++) {
                const monthOffset = i;
                const recordDate = new Date();
                recordDate.setMonth(today.getMonth() - monthOffset);
                
                const startDate = new Date(recordDate);
                startDate.setDate(1);
                
                const endDate = new Date(startDate);
                endDate.setMonth(startDate.getMonth() + 1);
                endDate.setDate(0);
                
                const plans = ['Premium Plan', 'Standard Plan', 'Basic Plan'];
                const planGBs = ['50 GB', '30 GB', '20 GB'];
                const amounts = [599, 399, 299];
                
                const randomIndex = Math.floor(Math.random() * plans.length);
                
                // Format dates as DD-MM-YYYY
                const formatDate = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}-${month}-${year}`;
                };
                
                const formattedStartDate = formatDate(startDate);
                const formattedEndDate = formatDate(endDate);
                
                // Check if plan is active (end date is in future)
                const isActive = isDateInFuture(formattedEndDate);
                
                sampleRecords.push({
                    planName: plans[randomIndex],
                    planGB: planGBs[randomIndex],
                    planDuration: '30 Days',
                    planStartDate: formattedStartDate,
                    planEndDate: formattedEndDate,
                    amountPaid: amounts[randomIndex],
                    recordedAt: startDate.toISOString(),
                    isActive: isActive && i === 0 // Only make the most recent one active if end date is in future
                });
            }
            
            // Add sample records to history
            history = [...sampleRecords, ...history];
            
            // Keep only 36 records
            if (history.length > 36) {
                history = history.slice(0, 36);
            }
            
            localStorage.setItem(historyKey, JSON.stringify(history));
        }

        // ====== FORGOT PASSWORD FUNCTIONS ======
        function openForgotPasswordModal() {
            elements.forgotPasswordModal.style.display = 'flex';
            elements.forgotEmail.value = '';
            elements.forgotPhone.value = '';
            elements.forgotDOB.value = '';
            elements.forgotPasswordError.style.display = 'none';
            elements.forgotPasswordLoading.style.display = 'none';
            elements.forgotPasswordActions.style.display = 'flex';
        }

        function closeForgotPasswordModal() {
            elements.forgotPasswordModal.style.display = 'none';
            // Don't clear userToReset here - it's needed for reset password
        }

        function handleForgotPassword(e) {
            e.preventDefault();
            
            const emailId = elements.forgotEmail.value.trim();
            const phone = elements.forgotPhone.value.trim();
            const dobInput = elements.forgotDOB.value.trim();
            
            console.log('Forgot password attempt:', { emailId, phone, dobInput });
            
            if (!emailId || !phone || !dobInput) {
                showForgotPasswordError('Please enter all required details.');
                return;
            }
            
            if (!validateEmail(emailId)) {
                showForgotPasswordError('Please enter a valid email address.');
                return;
            }
            
            const normalizedDOB = normalizeDateForComparison(dobInput);
            if (!/^\d{2}-\d{2}-\d{4}$/.test(normalizedDOB)) {
                showForgotPasswordError('Please enter Date of Birth in DD-MM-YYYY format.');
                return;
            }
            
            hideForgotPasswordError();
            elements.forgotPasswordLoading.style.display = 'block';
            elements.forgotPasswordActions.style.display = 'none';
            elements.btnVerifyDetails.disabled = true;
            
            setTimeout(() => {
                const userData = verifyUserDetails(emailId, phone, normalizedDOB);
                
                if (userData) {
                    console.log('User verified, storing userToReset:', userData);
                    userToReset = userData;  // Store user data
                    console.log('userToReset after setting:', userToReset);
                    
                    closeForgotPasswordModal();
                    
                    // Small delay to ensure modal transition completes
                    setTimeout(() => {
                        console.log('Opening reset password modal, userToReset:', userToReset);
                        openResetPasswordModal();
                    }, 300);
                } else {
                    showForgotPasswordError('Verification failed. Please check your details and try again.');
                    shakeForgotPasswordForm();
                    userToReset = null;  // Clear if verification fails
                }
                
                elements.forgotPasswordLoading.style.display = 'none';
                elements.forgotPasswordActions.style.display = 'flex';
                elements.btnVerifyDetails.disabled = false;
            }, 1000);
        }

        function verifyUserDetails(emailId, phone, dob) {
            console.log('Verifying user:', emailId, phone, dob);
            
            // First check permanent storage
            const permanentData = getUserDataPermanently(emailId);
            console.log('Permanent data found:', permanentData);
            
            if (permanentData) {
                const userDOB = formatDateToDDMMYYYY(permanentData.dob || '');
                const normalizedUserDOB = normalizeDateForComparison(userDOB);
                
                // Check if phone matches (normalize both for comparison)
                const userPhone = (permanentData.phone || '').toString().trim().replace(/\s+/g, '');
                const inputPhone = phone.trim().replace(/\s+/g, '');
                
                console.log('Comparing:', {
                    userPhone: userPhone,
                    inputPhone: inputPhone,
                    userDOB: normalizedUserDOB,
                    inputDOB: dob
                });
                
                if (userPhone === inputPhone && normalizedUserDOB === dob) {
                    console.log('Verification successful with permanent data');
                    return permanentData;
                }
            }
            
            // Also check admin storage (user_ prefix)
            const keys = Object.keys(localStorage);
            console.log('Checking admin storage, total keys:', keys.length);
            
            for (const key of keys) {
                if (key.startsWith('user_')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        
                        // Check if this is the user by email
                        let userEmail = '';
                        try {
                            if (userData.encryptedData) {
                                const decrypted = JSON.parse(decryptData(userData.encryptedData));
                                userEmail = decrypted.personalInfo?.email || '';
                            }
                        } catch (decryptError) {
                            console.error('Error decrypting email:', decryptError);
                        }
                        
                        if (!userEmail && userData.email) {
                            try {
                                userEmail = decryptData(userData.email);
                            } catch (e) {
                                userEmail = userData.email;
                            }
                        }
                        
                        // Also check userId
                        if (!userEmail && userData.userId) {
                            userEmail = userData.userId;
                        }
                        
                        console.log('Checking user:', { key, userEmail, userId: userData.userId });
                        
                        if (userEmail && (userEmail === emailId || userData.userId === emailId)) {
                            // Extract personal info for verification
                            const extractedData = extractRequiredFields(userData);
                            const userDOB = formatDateToDDMMYYYY(extractedData.dob || '');
                            const normalizedUserDOB = normalizeDateForComparison(userDOB);
                            
                            // Normalize phone numbers for comparison
                            const userPhone = (extractedData.phone || '').toString().trim().replace(/\s+/g, '');
                            const inputPhone = phone.trim().replace(/\s+/g, '');
                            
                            console.log('Admin storage comparison:', {
                                userPhone: userPhone,
                                inputPhone: inputPhone,
                                userDOB: normalizedUserDOB,
                                inputDOB: dob
                            });
                            
                            if (userPhone === inputPhone && normalizedUserDOB === dob) {
                                console.log('Verification successful with admin storage');
                                return extractedData;
                            }
                        }
                    } catch (parseError) {
                        console.error('Error parsing user data:', parseError);
                        continue;
                    }
                }
            }
            
            console.log('No user found matching the criteria');
            return null;
        }

        // ====== RESET PASSWORD FUNCTIONS ======
        function openResetPasswordModal() {
            console.log('openResetPasswordModal called, userToReset:', userToReset);
            
            if (!userToReset) {
                alert('User data not found. Please go through the forgot password process again.');
                
                // Show forgot password modal again
                openForgotPasswordModal();
                return;
            }
            
            elements.resetPasswordModal.style.display = 'flex';
            elements.resetNewPassword.value = '';
            elements.resetConfirmPassword.value = '';
            elements.resetPasswordMatchError.style.display = 'none';
            elements.btnResetPassword.disabled = false;
            
            // Debug: show user info in console
            console.log('Opening reset modal for user:', {
                userId: userToReset.userId,
                email: userToReset.email,
                name: userToReset.fullName
            });
        }

        function closeResetPasswordModal() {
            elements.resetPasswordModal.style.display = 'none';
            userToReset = null;
        }

        function checkResetPasswordMatch() {
            const newPass = elements.resetNewPassword.value;
            const confirmPass = elements.resetConfirmPassword.value;
            
            if (newPass && confirmPass && newPass !== confirmPass) {
                elements.resetPasswordMatchError.style.display = 'block';
                elements.btnResetPassword.disabled = true;
            } else {
                elements.resetPasswordMatchError.style.display = 'none';
                elements.btnResetPassword.disabled = !(newPass && confirmPass);
            }
        }

        function handleResetPassword(e) {
            e.preventDefault();
            
            console.log('Reset password button clicked, userToReset:', userToReset);
            
            const newPassword = elements.resetNewPassword.value;
            const confirmPassword = elements.resetConfirmPassword.value;
            
            if (newPassword !== confirmPassword) {
                elements.resetPasswordMatchError.style.display = 'block';
                return;
            }
            
            if (!validatePasswordStrength(newPassword)) {
                alert('Password does not meet requirements. Please ensure it has:\n- Minimum 8 characters\n- At least one uppercase letter\n- At least one lowercase letter\n- At least one number\n- At least one special character');
                return;
            }
            
            // Check userToReset with more detailed logging
            if (!userToReset) {
                console.error('userToReset is null or undefined at reset time');
                console.log('Available variables:', {
                    currentUserData: currentUserData,
                    currentUserId: currentUserId,
                    userToReset: userToReset
                });
                
                alert('User session expired. Please try the forgot password process again from the beginning.');
                closeResetPasswordModal();
                
                // Show forgot password modal again
                setTimeout(() => {
                    openForgotPasswordModal();
                }, 500);
                return;
            }
            
            console.log('Proceeding with password reset for:', userToReset.email || userToReset.userId);
            
            elements.btnResetPassword.disabled = true;
            elements.btnResetPassword.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting Password...';
            
            setTimeout(() => {
                try {
                    const userId = userToReset.userId || userToReset.email;
                    console.log('Resetting password for user ID:', userId);
                    
                    if (!userId) {
                        throw new Error('No user ID found in userToReset');
                    }
                    
                    // Try to find the user in storage again
                    const userInStorage = verifyUserDetails(userToReset.email || userId, userToReset.phone || '', userToReset.dob || '');
                    if (!userInStorage) {
                        throw new Error('User not found in storage. Data may have been modified.');
                    }
                    
                    // Update in permanent storage
                    const permanentData = getUserDataPermanently(userId);
                    if (permanentData) {
                        permanentData.isFirstLogin = false;
                        permanentData.updatedAt = new Date().toISOString();
                        localStorage.setItem(USER_DATA_PREFIX + userId, JSON.stringify(permanentData));
                        console.log('Updated permanent storage for:', userId);
                    } else {
                        // Create permanent entry if it doesn't exist
                        const newPermanentData = {
                            ...userToReset,
                            isFirstLogin: false,
                            savedAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            isPermanent: true,
                            source: 'password_reset'
                        };
                        localStorage.setItem(USER_DATA_PREFIX + userId, JSON.stringify(newPermanentData));
                        console.log('Created new permanent storage for:', userId);
                    }
                    
                    // Update in admin storage if it exists
                    const adminKey = `user_${userId}`;
                    const adminData = localStorage.getItem(adminKey);
                    if (adminData) {
                        try {
                            const parsedData = JSON.parse(adminData);
                            if (parsedData.encryptedData) {
                                const decrypted = JSON.parse(decryptData(parsedData.encryptedData));
                                decrypted.password = encryptData(newPassword);
                                parsedData.encryptedData = encryptData(JSON.stringify(decrypted));
                                localStorage.setItem(adminKey, JSON.stringify(parsedData));
                                console.log('Updated admin storage for:', userId);
                            }
                        } catch (adminError) {
                            console.error('Error updating admin storage:', adminError);
                        }
                    }
                    
                    // Update log
                    updateUserLog(userId, {
                        isFirstLogin: false,
                        passwordResetAt: new Date().toISOString(),
                        resetMethod: 'forgot_password'
                    });
                    
                    console.log('Password reset successful for:', userId);
                    showSuccessToast('Password Reset Successfully!', 'You can now login with your new password.');
                    
                    setTimeout(() => {
                        closeResetPasswordModal();
                        elements.btnResetPassword.disabled = false;
                        elements.btnResetPassword.innerHTML = '<i class="fas fa-save"></i> Reset Password';
                        
                        // Clear the forgot password form
                        elements.forgotEmail.value = '';
                        elements.forgotPhone.value = '';
                        elements.forgotDOB.value = '';
                        
                        // Clear userToReset after successful reset
                        userToReset = null;
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error resetting password:', error);
                    alert('Error resetting password. Please try again.\n\nError: ' + error.message);
                    elements.btnResetPassword.disabled = false;
                    elements.btnResetPassword.innerHTML = '<i class="fas fa-save"></i> Reset Password';
                }
            }, 1000);
        }

        // ====== CHANGE PASSWORD FUNCTIONS ======
        function openChangePasswordModal() {
            elements.changePasswordModal.style.display = 'flex';
            elements.currentPassword.value = '';
            elements.newPassword.value = '';
            elements.confirmPassword.value = '';
            elements.passwordMatchError.style.display = 'none';
            elements.btnSubmitPassword.disabled = true;
        }

        function closeChangePasswordModal() {
            elements.changePasswordModal.style.display = 'none';
        }

        function checkPasswordMatch() {
            const newPass = elements.newPassword.value;
            const confirmPass = elements.confirmPassword.value;
            
            if (newPass && confirmPass && newPass !== confirmPass) {
                elements.passwordMatchError.style.display = 'block';
                elements.btnSubmitPassword.disabled = true;
            } else {
                elements.passwordMatchError.style.display = 'none';
                elements.btnSubmitPassword.disabled = !(newPass && confirmPass);
            }
        }

        function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = elements.currentPassword.value;
            const newPassword = elements.newPassword.value;
            const confirmPassword = elements.confirmPassword.value;
            
            // Allow default password for first time login
            if (isFirstTimeLogin && currentPassword === DEFAULT_PASSWORD) {
                // This is allowed for first time login
            } else if (!verifyPassword(currentUserData, currentPassword)) {
                showLoginError('Current password is incorrect.');
                closeChangePasswordModal();
                return;
            }
            
            if (newPassword !== confirmPassword) {
                elements.passwordMatchError.style.display = 'block';
                return;
            }
            
            if (!validatePasswordStrength(newPassword)) {
                showLoginError('New password does not meet requirements.');
                return;
            }
            
            if (currentPassword === newPassword) {
                showLoginError('New password must be different from current password.');
                return;
            }
            
            elements.btnSubmitPassword.disabled = true;
            elements.btnSubmitPassword.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Changing Password...';
            
            setTimeout(() => {
                try {
                    const userId = currentUserData.userId || currentUserData.email;
                    
                    // Update in permanent storage
                    const permanentData = getUserDataPermanently(userId);
                    if (permanentData) {
                        permanentData.isFirstLogin = false;
                        permanentData.updatedAt = new Date().toISOString();
                        localStorage.setItem(USER_DATA_PREFIX + userId, JSON.stringify(permanentData));
                    }
                    
                    // Update in admin storage if it exists
                    const adminKey = `user_${userId}`;
                    const adminData = localStorage.getItem(adminKey);
                    if (adminData) {
                        const parsedData = JSON.parse(adminData);
                        if (parsedData.encryptedData) {
                            const decrypted = JSON.parse(decryptData(parsedData.encryptedData));
                            decrypted.password = encryptData(newPassword);
                            parsedData.encryptedData = encryptData(JSON.stringify(decrypted));
                            localStorage.setItem(adminKey, JSON.stringify(parsedData));
                        }
                    }
                    
                    // Update log
                    updateUserLog(userId, {
                        isFirstLogin: false,
                        passwordChangedAt: new Date().toISOString()
                    });
                    
                    showSuccessToast('Password Changed Successfully!', 'You will be logged out automatically.');
                    
                    // Hide security alert
                    elements.securityAlert.style.display = 'none';
                    
                    // Automatically logout after 2 seconds
                    setTimeout(() => {
                        resetLogin();
                        closeChangePasswordModal();
                        elements.btnSubmitPassword.disabled = false;
                        elements.btnSubmitPassword.innerHTML = '<i class="fas fa-save"></i> Change Password';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error updating password:', error);
                    showLoginError('Error updating password. Please try again.');
                    elements.btnSubmitPassword.disabled = false;
                    elements.btnSubmitPassword.innerHTML = '<i class="fas fa-save"></i> Change Password';
                }
            }, 1000);
        }

        // ====== RECHARGE FUNCTION ======
        function rechargeNow() {
            alert('Recharge functionality will be configured later. For now, please contact administrator for recharge.');
        }

        // ====== UTILITY FUNCTIONS ======
        function resetLogin() {
            elements.loginForm.reset();
            elements.userInfoSection.style.display = 'none';
            elements.loginSection.style.display = 'block';
            elements.securityAlert.style.display = 'none';
            hideLoginError();
            hideFirstTimeNote();
            currentUserData = null;
            currentUserId = null;
            isFirstTimeLogin = false;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showLoginError(message) {
            elements.loginErrorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            elements.loginErrorMessage.style.display = 'block';
            shakeForm();
        }

        function hideLoginError() {
            elements.loginErrorMessage.style.display = 'none';
        }

        function showForgotPasswordError(message) {
            elements.forgotPasswordError.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
            elements.forgotPasswordError.style.display = 'block';
            shakeForgotPasswordForm();
        }

        function hideForgotPasswordError() {
            elements.forgotPasswordError.style.display = 'none';
        }

        function shakeForm() {
            elements.loginSection.style.animation = 'shake 0.5s ease';
            setTimeout(() => {
                elements.loginSection.style.animation = '';
            }, 500);
        }

        function shakeForgotPasswordForm() {
            elements.forgotPasswordModal.style.animation = 'shake 0.5s ease';
            setTimeout(() => {
                elements.forgotPasswordModal.style.animation = '';
            }, 500);
        }

        function showSuccessToast(title, message) {
            const toast = elements.passwordSuccessToast;
            toast.querySelector('.toast-title').textContent = title;
            toast.querySelector('.toast-message').textContent = message;
            toast.style.display = 'flex';
            toast.style.animation = 'slideIn 0.3s ease';
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
            
            .fa-spinner {
                animation: spin 1s linear infinite;
            }
        `;
        document.head.appendChild(style);
    </script>
<script src="user_status.js"></script>


</body>
</html>
